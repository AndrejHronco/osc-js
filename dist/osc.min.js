!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.OSC=t.OSC||{})}(this,function(t){"use strict";function e(t){return Number(t)===t&&t%1===0}function n(t){return Number(t)===t&&t%1!==0}function r(t){return"string"==typeof t}function i(t){return"[object Array]"===Object.prototype.toString.call(t)}function o(t){return"[object Object]"===Object.prototype.toString.call(t)}function a(t){return"function"==typeof t}function s(t){return t instanceof Uint8Array}function u(t){return t instanceof Date}function c(t){return t+3&-4}function f(t){return t.buffer?new DataView(t.buffer):t instanceof ArrayBuffer?new DataView(t):new DataView(new Uint8Array(t))}function h(t){if(e(t))return"i";if(n(t))return"f";if(r(t))return"s";if(s(t))return"b";throw new Error("OSC Message found unknown value type.")}function l(t){var e="";if(i(t))return"/"+t.join("/");if(r(t))return e=t,e.length>1&&"/"===e[e.length-1]&&(e=e.slice(0,e.length-1)),e.length>1&&"/"!==e[0]&&(e="/"+e),e;throw new Error("OSC Helpers can only prepare addresses which are of type array or string.")}function p(t){var e=void 0;if(!r(t))throw new Error("OSC Helper prepareRegExPattern only accepts strings.");return e=t.replace(/\./g,"\\."),e=e.replace(/\(/g,"\\("),e=e.replace(/\)/g,"\\)"),e=e.replace(/\{/g,"("),e=e.replace(/\}/g,")"),e=e.replace(/,/g,"|"),e=e.replace(/\[!/g,"[^"),e=e.replace(/\?/g,"."),e=e.replace(/\*/g,".*")}var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},w=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),g=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},y=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},m=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},b=function(){function t(){v(this,t),this.data=[],this.byteLength=0}return w(t,[{key:"add",value:function(t){var e=t.pack();return this.byteLength+=e.byteLength,this.data.push(e),this}},{key:"merge",value:function(){var t=new Uint8Array(this.byteLength),e=0;return this.data.forEach(function(n){t.set(n,e),e+=n.byteLength}),t}}]),t}(),O=function(){function t(e){v(this,t),this.value=e,this.offset=0}return w(t,[{key:"pack",value:function(t,e){if(!t||!e)throw new Error("OSC Atomic cant't be packed without given method or byteLength.");var n=new Uint8Array(e),r=new DataView(n.buffer);if(!this.value)throw new Error("OSC Atomic cant't be encoded with empty value.");return r[t](this.offset,this.value,!1),n}},{key:"unpack",value:function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!(t&&e&&n))throw new Error("OSC Atomic cant't be unpacked without given dataView, method or byteLength.");if(!(t instanceof DataView))throw new Error("OSC Atomic expects an instance of type DataView.");return this.value=t[e](r,!1),this.offset=r+n,this.offset}}]),t}(),k=function(t){function n(t){if(v(this,n),t&&!e(t))throw new Error("OSC AtomicInt32 constructor expects value of type number.");return m(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t))}return y(n,t),w(n,[{key:"pack",value:function(){return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"pack",this).call(this,"setInt32",4)}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"unpack",this).call(this,t,"getInt32",4,e)}}]),n}(O),E=function(t){function e(t){if(v(this,e),t&&!n(t))throw new Error("OSC AtomicFloat32 constructor expects value of type float.");return m(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return y(e,t),w(e,[{key:"pack",value:function(){return g(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"pack",this).call(this,"setFloat32",4)}},{key:"unpack",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return g(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"unpack",this).call(this,t,"getFloat32",4,n)}}]),e}(O),S=function(t){function e(t){if(v(this,e),t&&!r(t))throw new Error("OSC AtomicString constructor expects value of type string.");return m(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return y(e,t),w(e,[{key:"pack",value:function(){if(!this.value)throw new Error("OSC AtomicString can not be encoded with empty value.");for(var t=this.value+"\0",e=c(t.length),n=new Uint8Array(e),r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC AtomicString expects an instance of type DataView.");for(var n=e,r=void 0,i=[];n<t.byteLength;n+=1){if(r=t.getUint8(n),0===r){n+=1;break}i.push(r)}if(n===t.length)throw new Error("OSC AtomicString found a malformed OSC string.");return this.offset=c(n),this.value=String.fromCharCode.apply(null,i),this.offset}}]),e}(O),C=function(t){function e(t){if(v(this,e),t&&!s(t))throw new Error("OSC AtomicBlob constructor expects value of type Uint8Array.");return m(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return y(e,t),w(e,[{key:"pack",value:function(){if(!this.value)throw new Error("OSC AtomicBlob can not be encoded with empty value.");var t=c(this.value.byteLength),e=new Uint8Array(t+4),n=new DataView(e.buffer);return n.setInt32(0,this.value.byteLength,!1),e.set(this.value,4),e}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC AtomicBlob expects an instance of type DataView.");var n=t.getInt32(e,!1);return this.value=new Uint8Array(t.buffer,e+4,n),this.offset=c(e+4+n),this.offset}}]),e}(O),_=function(){function t(){v(this,t),this.offset=0,this.address="",this.types="",this.args=[];for(var e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];if(n.length>0){if(!r(n[0])&&!i(n[0]))throw new Error("OSC Message constructor first argument (address) must be a string or array.");this.address=l(n.shift()),this.types=n.map(function(t){return h(t)}).join(""),this.args=n}}return w(t,[{key:"add",value:function(t){if(!t)throw new Error("OSC Message expects a valid item for adding.");this.args.push(t),this.types+=h(t)}},{key:"pack",value:function(){var t=this;if(0===this.address.length||"/"!==this.address[0])throw new Error("OSC Message does not have a proper address.");var i=new b;return i.add(new S(this.address)),i.add(new S(","+this.types)),this.args.length>0&&!function(){var o=void 0;t.args.forEach(function(t){if(e(t))o=new k(t);else if(n(t))o=new E(t);else if(r(t))o=new S(t);else{if(!s(t))throw new Error("OSC Message found unknown argument type.");o=new C(t)}i.add(o)})}(),i.merge()}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC Message expects an instance of type DataView.");var n=new S;n.unpack(t,e);var r=new S;if(r.unpack(t,n.offset),0===n.value.length||"/"!==n.value[0])throw new Error("OSC Message found malformed or missing address string.");if(0===r.value.length&&","!==r.value[0])throw new Error("OSC Message found malformed or missing type string.");for(var i=r.offset,o=void 0,a=void 0,s=[],u=1;u<r.value.length;u+=1){if(a=r.value[u],"i"===a)o=new k;else if("f"===a)o=new E;else if("s"===a)o=new S;else{if("b"!==a)throw new Error("OSC Message found non-standard argument type.");o=new C}i=o.unpack(t,i),s.push(o.value)}return this.offset=i,this.address=n.value,this.types=r.value,this.args=s,this.offset}}]),t}(),j=2208988800,H=4294967296,A=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(v(this,t),!e(n)||!e(r))throw new Error("OSC Timetag constructor expects values of type integer number.");this.seconds=n,this.fractions=r}return w(t,[{key:"timestamp",value:function(t){var e=void 0;if("number"==typeof t){e=t/1e3;var n=Math.floor(e);return this.seconds=n+j,this.fractions=Math.round(H*(e-n)),t}return e=this.seconds-j,1e3*(e+this.fractions/H)}}]),t}(),D=function(t){function n(t){v(this,n);var r=new A;return t instanceof A?r=t:e(t)?r.timestamp(t):u(t)?r.timestamp(t.getTime()):r.timestamp(Date.now()),m(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,r))}return y(n,t),w(n,[{key:"pack",value:function(){if(!this.value)throw new Error("OSC AtomicTimetag can not be encoded with empty value.");var t=this.value,e=t.seconds,n=t.fractions,r=new Uint8Array(8),i=new DataView(r.buffer);return i.setInt32(0,e,!1),i.setInt32(4,n,!1),r}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC AtomicTimetag expects an instance of type DataView.");var n=t.getUint32(e,!1),r=t.getUint32(e+4,!1);return this.value=new A(n,r),this.offset=e+8,this.offset}}]),n}(O),P="#bundle",x=function(){function t(){var n=this;v(this,t),this.offset=0,this.timetag=new D,this.bundleElements=[];for(var r=arguments.length,o=Array(r),a=0;a<r;a++)o[a]=arguments[a];o.length>0&&(o[0]instanceof Date||e(o[0])?this.timetag=new D(o[0]):i(o[0])?(o[0].forEach(function(t){n.add(t)}),o.length>1&&(o[1]instanceof Date||e(o[0]))&&(this.timetag=new D(o[1]))):o.forEach(function(t){n.add(t)}))}return w(t,[{key:"timestamp",value:function(t){if(!e(t))throw new Error("OSC Bundle needs an Integer for setting its timestamp.");this.timetag=new D(t)}},{key:"add",value:function(e){if(!(e instanceof _||e instanceof t))throw new Error("OSC Bundle contains only Messages and Bundles.");this.bundleElements.push(e)}},{key:"pack",value:function(){var t=new b;return t.add(new S(P)),this.timetag||(this.timetag=new D),t.add(this.timetag),this.bundleElements.forEach(function(e){t.add(new k(e.pack().byteLength)),t.add(e)}),t.merge()}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC Bundle expects an instance of type DataView.");var n=new S;if(n.unpack(t,e),n.value!==P)throw new Error("OSC Bundle does not contain a valid #bundle head.");var r=new D,i=r.unpack(t,n.offset);for(this.bundleElements=[];i<t.byteLength;){var o=new M,a=new k;i=a.unpack(t,i),i=o.unpack(t,i,this.timetag),this.bundleElements.push(o.value)}return this.offset=i,this.timetag=r,this.offset}}]),t}(),M=function(){function t(e){if(v(this,t),e&&!(e instanceof _||e instanceof x))throw new Error("OSC Packet can only consist of Message or Bundle.");this.value=e,this.offset=0}return w(t,[{key:"pack",value:function(){if(!this.value)throw new Error("OSC Packet can not be encoded with empty body.");return this.value.pack()}},{key:"unpack",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!(t instanceof DataView))throw new Error("OSC Packet expects an instance of type DataView.");if(t.byteLength%4!==0)throw new Error("OSC Packet byteLength has to be a multiple of four.");var n=new S;n.unpack(t,e);var r=void 0;return r=n.value===P?new x:new _,r.unpack(t,e),this.offset=r.offset,this.value=r,this.offset}}]),t}(),V={discardLateMessages:!1},L=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};v(this,t),this.options=Object.assign({},V,e),this.addressHandlers=[],this.eventHandlers={open:[],error:[],close:[]},this.uuid=0}return w(t,[{key:"dispatch",value:function(t){var e=this;if(!(t instanceof M))throw new Error("OSC EventHander dispatch method only accepts arguments of type Packet.");if(!t.value)throw new Error("OSC EventHander dispatch method cant read empty Packets.");if(t.value instanceof x){var n=function(){var n=t.value;return{v:n.bundleElements.forEach(function(r){if(t.value instanceof x){if(n.timetag.value.timestamp()<r.timetag.value.timestamp())throw new Error("OSC Bundle timestamp is older than the timestamp of enclosed Bundles.");return e.dispatch(r)}if(r instanceof _){var i=r;return e.notify(i.address,i,n.timetag.value.timestamp())}throw new Error("OSC EventHander dispatch method can't dispatch unknown Packet value.")})}}();if("object"===("undefined"==typeof n?"undefined":d(n)))return n.v}else if(t.value instanceof _){var r=t.value;return this.notify(r.address,r)}throw new Error("OSC EventHander dispatch method can't dispatch unknown Packet value.")}},{key:"call",value:function(t,e){var n=!1;if(r(t)&&t in this.eventHandlers)return this.eventHandlers[t].forEach(function(t){t.callback(e),n=!0}),n;var i=Object.keys(this.addressHandlers),o=this.addressHandlers;return i.forEach(function(r){var i=new RegExp(p(l(t)),"g"),a=i.test(r);a&&r.length===i.lastIndex&&o[r].forEach(function(t){t.callback(e),n=!0})}),n}},{key:"notify",value:function(){for(var t=this,n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];if(0===i.length)throw new Error("OSC EventHandler can not be called without any argument.");if(i[0]instanceof M)return this.dispatch(i[0]);if(i[0]instanceof x||i[0]instanceof _)return this.dispatch(new M(i[0]));if(!r(i[0])){var a=new M;return a.unpack(f(i[0])),this.dispatch(a)}var s=i[0],u=null;i.length>1&&(u=i[1]);var c=null;if(i.length>2)if(e(i[2]))c=i[2];else{if(!(i[2]instanceof Date))throw new Error("OSC EventHandler timestamp has to be a number or Date.");c=i[2].getTime()}if(c){var h=function(){var e=Date.now();if(e>c&&!t.options.discardLateMessages)return{v:t.call(s,u)};var n=t;return setTimeout(function(){n.call(s,u)},c-e),{v:!0}}();if("object"===("undefined"==typeof h?"undefined":d(h)))return h.v}return this.call(s,u)}},{key:"on",value:function(t,e){if(!r(t)&&!i(t))throw new Error("OSC EventHandler accepts only strings or arrays for address patterns.");if(!a(e))throw new Error("OSC EventHandler callback has to be a function.");this.uuid+=1;var n={id:this.uuid,callback:e};if(r(t)&&t in this.eventHandlers)return this.eventHandlers[t].push(n),this.uuid;var o=l(t),s=new RegExp(/[#*\s[\],\/{}|?]/g);if(s.test(o.split("/").join("")))throw new Error("OSC EventHandler address string contains invalid characters.");return o in this.addressHandlers||(this.addressHandlers[o]=[]),this.addressHandlers[o].push(n),this.uuid}},{key:"off",value:function(t,n){if(!r(t)&&!i(t))throw new Error("OSC EventHandler accepts only strings or arrays for address patterns.");if(!e(n))throw new Error("OSC EventHandler subscription id has to be a number.");var o=void 0,a=void 0;return r(t)&&t in this.eventHandlers?(o=t,a=this.eventHandlers):(o=l(t),a=this.addressHandlers),o in a&&a[o].some(function(t,e){return t.id===n&&(a[o].splice(e,1),!0)})}}]),t}(),B={plugin:null,discardLateMessages:!1},U=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(v(this,t),!o(e))throw new Error("OSC options argument has to be an object.");this.options=Object.assign({},B,e),this.eventHandler=new L({discardLateMessages:this.options.discardLateMessages});var n=this.eventHandler;this.options.plugin&&this.options.plugin.registerNotify&&this.options.plugin.registerNotify(function(){return n.notify.apply(n,arguments)})}return w(t,[{key:"on",value:function(t,e){if(!r(t)||!a(e))throw new Error("OSC event listener needs an event or address string and a function as callback.");return this.eventHandler.on(t,e)}},{key:"off",value:function(t,n){if(!r(t)||!e(n))throw new Error("OSC listener needs a string and a listener id number to unsubscribe from event.");return this.eventHandler.off(t,n)}},{key:"open",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!o(t))throw new Error("OSC connection options argument has to be an object.");if(!this.options.plugin||!a(this.options.plugin.open))throw new Error("OSC connection#open is not implemented.");return this.options.plugin.open(t)}},{key:"status",value:function(){if(!this.options.plugin||!a(this.options.plugin.status))throw new Error("OSC connection#status is not implemented.");return this.options.plugin.status()}},{key:"close",value:function(){if(!this.options.plugin||!a(this.options.plugin.close))throw new Error("OSC connection#close is not implemented.");return this.options.plugin.close()}},{key:"send",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.options.plugin||!a(this.options.plugin.send))throw new Error("OSC connection#send is not implemented.");if(!(t instanceof _||t instanceof x||t instanceof M))throw new Error("OSC can only send Messages, Bundles or Packets.");if(!o(e))throw new Error("OSC connection options argument has to be an object.");return this.options.plugin.send(t.pack(this.options),e)}}]),t}();t.OSC=U,t.Packet=M,t.Bundle=x,t.Message=_,Object.defineProperty(t,"__esModule",{value:!0})});
